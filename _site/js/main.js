
var cities = [{
  "type": "FeatureCollection",
  "features": [
    {
      "type": "Feature",
      "properties": {
        "city": "berlin",
        "year": "2014",
        "marker-color": "#e87d2b"
      },
      "geometry": {
        "type": "Point",
        "coordinates": [
          13.388214,
          52.523741
        ]
      }
    },
    {
      "type": "Feature",
      "properties": {
        "city": "hamburg",
        "year": "2014",
        "marker-color": "#e87d2b"
      },
      "geometry": {
        "type": "Point",
        "coordinates": [
          9.992408,
          53.549283
        ]
      }
    },
    {
      "type": "Feature",
      "properties": {
        "city": "muenster",
        "year": "2014",
        "marker-color": "#e87d2b"
      },
      "geometry": {
        "type": "Point",
        "coordinates": [
          7.625198,
          51.962567
        ]
      }
    },
    {
      "type": "Feature",
      "properties": {
        "city": "paderborn",
        "year": "2014",
        "marker-color": "#e87d2b"
      },
      "geometry": {
        "type": "Point",
        "coordinates": [
          8.754472,
          51.718521
        ]
      }
    },
    {
      "type": "Feature",
      "properties": {
        "city": "leipzig",
        "year": "2014",
        "marker-color": "#e87d2b"
      },
      "geometry": {
        "type": "Point",
        "coordinates": [
          12.376613,
          51.340585
        ]
      }
    },
    {
      "type": "Feature",
      "properties": {
        "city": "dresden",
        "year": "2014",
        "marker-color": "#e87d2b"
      },
      "geometry": {
        "type": "Point",
        "coordinates": [
          13.738231,
          51.051538
        ]
      }
    },
    {
      "type": "Feature",
      "properties": {
        "city": "chemnitz",
        "year": "2014",
        "marker-color": "#e87d2b"
      },
      "geometry": {
        "type": "Point",
        "coordinates": [
          12.918548,
          50.833589
        ]
      }
    },
    {
      "type": "Feature",
      "properties": {
        "city": "koeln",
        "year": "2014",
        "marker-color": "#e87d2b"
      },
      "geometry": {
        "type": "Point",
        "coordinates": [
          6.958122,
          50.938527
        ]
      }
    },
    {
      "type": "Feature",
      "properties": {
        "city": "giessen",
        "year": "2014",
        "marker-color": "#e87d2b"
      },
      "geometry": {
        "type": "Point",
        "coordinates": [
          8.674135,
          50.587105
        ]
      }
    },
    {
      "type": "Feature",
      "properties": {
        "city": "heilbronn",
        "year": "2014",
        "marker-color": "#e87d2b"
      },
      "geometry": {
        "type": "Point",
        "coordinates": [
          9.219417,
          49.143257
        ]
      }
    },
    {
      "type": "Feature",
      "properties": {
        "city": "stuttgart",
        "year": "2014",
        "marker-color": "#e87d2b"
      },
      "geometry": {
        "type": "Point",
        "coordinates": [
          9.176673,
          48.777234
        ]
      }
    },
    {
      "type": "Feature",
      "properties": {
        "city": "ulm",
        "year": "2014",
        "marker-color": "#e87d2b"
      },
      "geometry": {
        "type": "Point",
        "coordinates": [
          9.993181,
          48.396442
        ]
      }
    },
    {
      "type": "Feature",
      "properties": {
        "city": "muenchen",
        "year": "2014",
        "marker-color": "#e87d2b"
      },
      "geometry": {
        "type": "Point",
        "coordinates": [
          11.574954,
          48.138714
        ]
      }
    },
    {
      "type": "Feature",
      "properties": {
        "city": "magdeburg",
        "year": "2015",
        "marker-color": "#e87d2b"
      },
      "geometry": {
        "type": "Point",
        "coordinates": [
          11.638469,
          52.135279
        ]
      }
    },
    {
      "type": "Feature",
      "properties": {
        "city": "jena",
        "year": "2015",
        "marker-color": "#e87d2b"
      },
      "geometry": {
        "type": "Point",
        "coordinates": [
          11.583366,
          50.932252
        ]
      }
    },
    {
      "type": "Feature",
      "properties": {
        "city": "frankfurt",
        "year": "2015",
        "marker-color": "#e87d2b"
      },
      "geometry": {
        "type": "Point",
        "coordinates": [
          8.681602,
          50.114303
        ]
      }
    },
    {
      "type": "Feature",
      "properties": {
        "city": "wuppertal",
        "year": "2015",
        "marker-color": "#e87d2b"
      },
      "geometry": {
        "type": "Point",
        "coordinates": [
          7.177076,
          51.262827
        ]
      }
    },
    {
      "type": "Feature",
      "properties": {
        "city": "karlsruhe",
        "year": "2015",
        "marker-color": "#e87d2b"
      },
      "geometry": {
        "type": "Point",
        "coordinates": [
          8.404283,
          49.012541
        ]
      }
    },
    {
      "type": "Feature",
      "properties": {
        "city": "bonn",
        "year": "2015",
        "marker-color": "#e87d2b"
      },
      "geometry": {
        "type": "Point",
        "coordinates": [
          7.100944,
          50.736889
        ]
      }
    },
    {
      "type": "Feature",
      "properties": {
        "city": "freiburg",
        "year": "2015",
        "marker-color": "#e87d2b"
      },
      "geometry": {
        "type": "Point",
        "coordinates": [
          7.851705,
          47.994804
        ]
      }
    },
    {
      "type": "Feature",
      "properties": {
        "city": "kassel",
        "year": "2016",
        "marker-color": "#e87d2b"
      },
      "geometry": {
        "type": "Point",
        "coordinates": [
          9.477767,
          51.310657
        ]
      }
    },
    {
      "type": "Feature",
      "properties": {
        "city": "erlangen",
        "year": "2016",
        "marker-color": "#e87d2b"
      },
      "geometry": {
        "type": "Point",
        "coordinates": [
          11.003150,
          49.596247
        ]
      }
    },
    {
      "type": "Feature",
      "properties": {
        "city": "duesseldorf",
        "year": "2016",
        "marker-color": "#e87d2b"
      },
      "geometry": {
        "type": "Point",
        "coordinates": [
          6.779937,
          51.222152
        ]
      }
    },
    {
      "type": "Feature",
      "properties": {
        "city": "ruhr",
        "year": "2016",
        "marker-color": "#e87d2b"
      },
      "geometry": {
        "type": "Point",
        "coordinates": [
          6.747534,
          51.567426
        ]
      }
    },
    {
      "type": "Feature",
      "properties": {
        "city": "hannover",
        "year": "2016",
        "marker-color": "#e87d2b"
      },
      "geometry": {
        "type": "Point",
        "coordinates": [
          9.739036,
          52.374760
        ]
      }
    },
    {
      "type": "Feature",
      "properties": {
        "city": "niederrhein",
        "year": "2016",
        "marker-color": "#e87d2b"
      },
      "geometry": {
        "type": "Point",
        "coordinates": [
          7.010650,
          51.458927
        ]
      }
    }
  ]
}]

if (typeof console === "undefined" || typeof console.log === "undefined") {
  console = {log:function(){}};
}

$(function(){
  var readytoshow = false;
  $('<img/>').attr('src', 'img/iphone.jpg').load(function() {
    if(readytoshow)
      $("#loading").fadeOut({duration:1000});
    readytoshow = true;
  });
  setTimeout(function(){
    if(readytoshow)
      $("#loading").fadeOut({duration:1000});
    readytoshow = true;
  }, 1000);
  var usTopology;
  //shows nav when user hovers over the logo
  var height = $(window).height(),
  width = $(window).width();

  var setSize = function(){
    height = $(window).height();
    width = $(window).width();

    $(".quote").css({width:width, "min-height":height});
    $(".story").css({width:width, "min-height":height});
    $(".pagebg").css({width:width, "min-height":height});
    $(".scrollout").css({height:height});
    $(".fellowship").css({height:height});
    $(".map").css({height:height});
    $(".mapscroll").css({height:height});
    scrollEvent.onScroll();

  }

  // var tabContentWidth = $('.yeartitle').css('width')
  // console.log(tabContentWidth);
  // $('.tab-content .tab-pane').css('width', tabContentWidth)

  var scrollEvent = {
    handlers: {top:[], middle:[], bottom:[], inview:[]},
    currentElements: {top:[], middle:[], bottom:[], inview:[]},
    on:function(pos, el, addCb, removeCb){
      var elements = el.toArray();
      var i = 0;
      for(e in elements){
        if(typeof elements[e] !== "object")
          continue;
        scrollEvent.handlers[pos].push({el:elements[e], addCb:addCb, removeCb:removeCb, count:i});
        i++;
      }
    },
    onScroll:function(){
      var pos = $(window).scrollTop();
      var height = $(window).height();

      if(pos < 0)
        return;

      for(e in scrollEvent.handlers.middle){
        var el = scrollEvent.handlers.middle[e].el;
        if(typeof el !== "object")
          continue;

        // console.log(el);
        //middle
        if(($(el).offset().top <= (pos + height/2)) &&
           ($(el).offset().top + $(el).outerHeight()  >= (pos + height/2))){
          scrollEvent.setCurrentElement("middle", scrollEvent.handlers.middle[e]);
       }else{
          scrollEvent.removeCurrentElement("middle", scrollEvent.handlers.middle[e]);
        }
      }

      for(e in scrollEvent.handlers.top){
        var el = scrollEvent.handlers.top[e].el;
        if(typeof el !== "object")
          continue;

        //if the element is at the top of the page
        if(($(el).offset().top <= pos) &&
           ($(el).offset().top + $(el).outerHeight()  >= pos)){
          scrollEvent.setCurrentElement("top", scrollEvent.handlers.top[e]);

        }else{
          scrollEvent.removeCurrentElement("top", scrollEvent.handlers.top[e]);
        }
      }
      for(e in scrollEvent.handlers.bottom){
        var el = scrollEvent.handlers.bottom[e].el;
        if(typeof el !== "object")
          continue;

        //if the element is at the top of the page
        if(($(el).offset().top <= (pos+ height)) &&
           ($(el).offset().top + $(el).outerHeight()  >= (pos +height))){
          scrollEvent.setCurrentElement("bottom", scrollEvent.handlers.bottom[e]);

        }else{
          scrollEvent.removeCurrentElement("bottom", scrollEvent.handlers.bottom[e]);
        }
      }
      for(e in scrollEvent.handlers.inview){
        var el = scrollEvent.handlers.inview[e].el;
        if(typeof el !== "object")
          continue;

        //if the element is at the top of the page
        if(($(el).offset().top + $(el).outerHeight() >= pos) &&
           ($(el).offset().top   <= (pos +height))){
          scrollEvent.setCurrentElement("inview", scrollEvent.handlers.inview[e]);

        }else{
          scrollEvent.removeCurrentElement("inview", scrollEvent.handlers.inview[e]);
        }
      }


    },
    setCurrentElement:function(pos, handler){

      if(scrollEvent.currentElements[pos].indexOf(handler) === -1){
        scrollEvent.currentElements[pos].push(handler);
        handler.addCb(handler.el,handler.count);
      }
    },
    removeCurrentElement:function(pos, handler){

      if(scrollEvent.currentElements[pos].indexOf(handler) >=0 ){
        delete scrollEvent.currentElements[pos][scrollEvent.currentElements[pos].indexOf(handler)];
        handler.removeCb(handler.el,handler.count);
      }
    }
  };

  
  scrollEvent.on("middle", $(".page"), function(el,i){
    $($("div.pagebg")[i]).fadeIn({duration:500});
    if(($(el).attr("class").indexOf("quote") >= 0) || ($(el).attr("class").indexOf("nosidebar") >= 0))
      $("div.sidebartitle").hide();
    else{
      $($("div.sidebartitle")[i]).show();
      $($("div.sidebartitle")[i]).addClass("appear");
    }
  }, function(el, i){
    $($("div.pagebg")[i]).fadeOut({duration:700});
    $($("div.sidebartitle")[i]).removeClass("appear");

  });
  scrollEvent.on("inview", $("iframe[data-src]"), function(el,i){
    if($(el).attr("src") === undefined)
      $(el).attr("src", $(el).attr("data-src"))
  }, function(el, i, pos){
  });


  var showRandomTooltip = function(){

    currentMarker = displayedMarkers[Math.floor(Math.random()*displayedMarkers.length)]

    currentMarker.showTooltip();

    point = map.locationPoint({
      lat: currentMarker.data.geometry.coordinates[1],
      lon: currentMarker.data.geometry.coordinates[0]
    })

    var quarter = map.dimensions.y * (1/ 4);
    point.y -= quarter;
    map.ease.location(map.pointLocation(point)).zoom(map.zoom()).optimal();

  }

  scrollEvent.onScroll();
  $(window).scroll(scrollEvent.onScroll);


  setSize();
  $(window).resize(setSize);

  $('[id^="myCarousel"]').carousel({
    interval: false,
    cycle: true
  });

  $('.captpop').popover({
    placement: 'top',
    trigger: 'hover'
  });

  $('.morefellowspop').popover({
    placement: 'top',
    trigger: 'hover'
  });

  $('.appspop').popover({
    placement: 'top',
    trigger: 'hover',
    html: true
  });

  $('.footnote').popover({
    placement: 'top',
    trigger: 'hover'
  });

  $('.startupspop').popover({
    placement: 'top',
    trigger: 'hover',
    html: true
  });


  // Create map

  // Provide your access token
  L.mapbox.accessToken = 'pk.eyJ1IjoiZmxhcHBlcmxlZW5pZSIsImEiOiJjaWh5djNjc2swNDF3dHNraHJjZ3gwZDU1In0.MjECWrY22zXKIERRtRA4FA';
  // Create a map in the div #map
  var map = L.mapbox.map('map', 'flapperleenie.ok1jf4pj', {
    zoomControl: false
  }).setView([51, 9.8], 6);
  // Disable drag and zoom handlers.
  map.dragging.disable();
  map.touchZoom.disable();
  map.doubleClickZoom.disable();
  map.scrollWheelZoom.disable();
  map.keyboard.disable();

  var cities2016 = filterCitiesByYear("2016");
  var cities2015 = filterCitiesByYear("2015");
  var cities2014 = filterCitiesByYear("2014");

  function filterCitiesByYear(year) {
    var newCities = JSON.parse(JSON.stringify(cities));
    newCities[0].features = newCities[0].features.filter(function(item) {
          return item.properties.year === year
        });
    return newCities;
  }
  console.log('test');
  console.log(cities2015);

  var featureLayer2014 = L.mapbox.featureLayer(cities2014)
    // hide all markers
    .setFilter(function(){ return true; })
    .addTo(map);
  var featureLayer2015 = L.mapbox.featureLayer(cities2015)
      // hide all markers
      .setFilter(function(){ return true; });
  var featureLayer2016 = L.mapbox.featureLayer(cities2016)
      // hide all markers
      .setFilter(function(){ return true; });

  $('#2014 .btn').click(function() {
    map.removeLayer(featureLayer2016);
    map.removeLayer(featureLayer2015);
    //map.addLayer(featureLayer2014);
  })

  $('#2015 .btn').click(function() {
    map.removeLayer(featureLayer2016);
    map.addLayer(featureLayer2015);
  })

  $('#2016 .btn').click(function() {
    //map.removeLayer(featureLayer2014);
    map.addLayer(featureLayer2016);

  })


  var years = ["2014", "2015", "2016"]

  $.each(years, function(index, value){
    $('#'+value).on('show.bs.dropdown', function() {
      yearMarkers(value)
    })
  });

  function yearMarkers(year) {
    $svg = $("#marker");
    switch (year) {
      case "2014":
        $("#markerCircle", $svg).attr('style', "fill:#6D6E71");
      break;
      case "2015":
        $("#markerCircle", $svg).attr('style', "fill:#6D6E71");
      break;
      case "2016":
        $("#markerCircle", $svg).attr('style', "fill:#6D6E71");
      break;
      default:
        $("#markerCircle", $svg).attr('style', "fill:#e87d2b");
      break;
    }
    map.featureLayer.setFilter(function(f) {
     return f.properties.year <= year;
    });
    return false;
  }

  var arrowInterval =0;
  var mapcurrentyear = "2014";
  var timer;
  scrollEvent.on("middle", $(".mapscroll"), function(el,i){
    yearMarkers(2016);
  });

//   var 2014 = L.geoJson(cities, {
//     filter: function(feature, layer) {
//         return feature.properties.show_on_map;
//     }
// }).addTo(map);

  // var colors = ["#2f3d4a", "#384857", "#405264", "#50677C", "#839AAF", "#B4C2CF", "#E6EBEF", "#FFFFFF"];
  var colors = ["graph", "graph1", "graph2", "graph3", "graph4", "graph5", "graph6", "graph7"];

  $(".bargraph").each(function(i, el){

    var that = this;

    var total = 0;
    // Count all the money for each data point in the source
    $("."+$(el).attr("data-source")).each(function(i, el){
      // remove commas and dollar signs
      total += parseInt($(el).text().replace(/,/g, "").replace("$", ""));
    });

    // for each group add the hover events
    $(".financialsgroup").each(function(i, el) {
      var group = $(el).attr("data-group");
      $(el).hover(function() {
        $(el).addClass("active");
        $('.group' + group).addClass('active');
      }, function(){
        $(el).removeClass("active");
        $('.group' + group).removeClass('active');
      });
    });

    // for each data point add a section to the graph and hover events
    $("."+$(el).attr("data-source")).each(function(i, el){
      var count = parseInt($(el).text().replace(/,/g, "").replace("$", ""));
      var perc = (count/total)*100;
      var group = $(el).attr("data-group");

      // create section
      var section = $("<div class='graphsection'></div>").css({
        width:perc + "%"
      }).addClass(colors[i]);

      // add classs for group
      if(group !== undefined) {
        $(el).addClass('group' + group);
        section.addClass('group' + group);
      }

      //hover over the numbers
      $(el).hover(highlight, unhighlight);
      $(section).hover(highlight, unhighlight);

      function  highlight() {
        $(el).addClass('active');
        $(section).addClass('active');
      }

      function unhighlight() {
        $(el).removeClass('active');
        $(section).removeClass('active');
      }

      $(that).append(section);
    });

  });


 scrollEvent.on("top", $(".page"), function(el,i){

   $(".navbar li").removeClass("active");;
   if($(el).attr("data-section") !== "")
     $(".navbar li."+$(el).attr("data-section")).addClass("active");

 },function(){

 });
 scrollEvent.on("bottom", $(".page"), function(el,i){

   $(".navbar li").removeClass("active");;
   if($(el).attr("data-section") !== "")
     $(".navbar li."+$(el).attr("data-section")).addClass("active");

 },function(){

 });

  $(".navbar .nav li a").on("click touchend", function(e){
    e.preventDefault();
    var section = $(e.currentTarget).parent().attr("class").split(" ")[0];
    $("body,html").animate({scrollTop: $($("div.page[data-section='"+section+"']")[0]).offset().top}, 1000);
  });

});

if (!Array.prototype.indexOf)
{
  Array.prototype.indexOf = function(elt /*, from*/)
  {
    var len = this.length >>> 0;

    var from = Number(arguments[1]) || 0;
    from = (from < 0)
         ? Math.ceil(from)
         : Math.floor(from);
    if (from < 0)
      from += len;

    for (; from < len; from++)
    {
      if (from in this &&
          this[from] === elt)
        return from;
    }
    return -1;
  };
}
